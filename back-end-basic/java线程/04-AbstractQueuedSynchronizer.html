<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AbstractQueuedSynchronizer | 思考学习仓库</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="思考学习仓库沉淀">
    
    <link rel="preload" href="/back-end/assets/css/0.styles.e1ce56f9.css" as="style"><link rel="preload" href="/back-end/assets/js/app.e2101455.js" as="script"><link rel="preload" href="/back-end/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/back-end/assets/js/15.25f2f025.js" as="script">
    <link rel="stylesheet" href="/back-end/assets/css/0.styles.e1ce56f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/back-end/" class="home-link router-link-active"><!----> <span class="site-name">思考学习仓库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/back-end/" class="nav-link">
  思考学习仓库
</a></div><div class="nav-item"><a href="/back-end/back-end-basic/" class="nav-link router-link-active">
  java基础
</a></div><div class="nav-item"><a href="/back-end/middleware/" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/back-end/spring/" class="nav-link">
  Spring框架
</a></div><div class="nav-item"><a href="/back-end/microservices/" class="nav-link">
  微服务框架
</a></div><div class="nav-item"><a href="/back-end/database/" class="nav-link">
  数据库篇章
</a></div> <a href="https://github.com/think-studio/back-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/back-end/" class="nav-link">
  思考学习仓库
</a></div><div class="nav-item"><a href="/back-end/back-end-basic/" class="nav-link router-link-active">
  java基础
</a></div><div class="nav-item"><a href="/back-end/middleware/" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/back-end/spring/" class="nav-link">
  Spring框架
</a></div><div class="nav-item"><a href="/back-end/microservices/" class="nav-link">
  微服务框架
</a></div><div class="nav-item"><a href="/back-end/database/" class="nav-link">
  数据库篇章
</a></div> <a href="https://github.com/think-studio/back-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>java集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>java流</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>java线程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back-end/back-end-basic/java线程/01-JMM&amp;Volatile.html" class="sidebar-link">JMM&amp;volatile</a></li><li><a href="/back-end/back-end-basic/java线程/02-synchronized.html" class="sidebar-link">Synchronized</a></li><li><a href="/back-end/back-end-basic/java线程/03-ReentrantLock.html" class="sidebar-link">ReentrantLock</a></li><li><a href="/back-end/back-end-basic/java线程/04-AbstractQueuedSynchronizer.html" class="active sidebar-link">AbstractQueuedSynchronizer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back-end/back-end-basic/java线程/04-AbstractQueuedSynchronizer.html#_1-aqs基本介绍" class="sidebar-link">1. AQS基本介绍</a></li></ul></li><li><a href="/back-end/back-end-basic/java线程/thread.html" class="sidebar-link">thread</a></li><li><a href="/back-end/back-end-basic/java线程/threadLocal.html" class="sidebar-link">threadLocal</a></li><li><a href="/back-end/back-end-basic/java线程/Atomic系列.html" class="sidebar-link">Atomic系列</a></li><li><a href="/back-end/back-end-basic/java线程/ReentrantReadWriteLock.html" class="sidebar-link">ReentrantReadWriteLock</a></li><li><a href="/back-end/back-end-basic/java线程/StampedLock.html" class="sidebar-link">StampedLock</a></li><li><a href="/back-end/back-end-basic/java线程/CountDownLatch.html" class="sidebar-link">CountDownLatch</a></li><li><a href="/back-end/back-end-basic/java线程/CyclicBarrier.html" class="sidebar-link">CyclicBarrier</a></li><li><a href="/back-end/back-end-basic/java线程/ForkJoinPool.html" class="sidebar-link">ForkJoinPool</a></li><li><a href="/back-end/back-end-basic/java线程/ThreadPoolExecutor.html" class="sidebar-link">ThreadPoolExecutor</a></li><li><a href="/back-end/back-end-basic/java线程/cas.html" class="sidebar-link">cas</a></li><li><a href="/back-end/back-end-basic/java线程/CHL队列.html" class="sidebar-link">CHL队列</a></li><li><a href="/back-end/back-end-basic/java线程/Disruptor.html" class="sidebar-link">Disruptor</a></li><li><a href="/back-end/back-end-basic/java线程/java内存模型.html" class="sidebar-link">java内存模型</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>java网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>jvm</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="abstractqueuedsynchronizer"><a href="#abstractqueuedsynchronizer" class="header-anchor">#</a> AbstractQueuedSynchronizer</h1> <h2 id="_1-aqs基本介绍"><a href="#_1-aqs基本介绍" class="header-anchor">#</a> 1. AQS基本介绍</h2> <p>AQS的关键属性：</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer{
// 指向同步队列的头部
private transient volatile Node head;
// 指向同步队列的尾部
private transient volatile Node tail;
// 同步状态标识
private volatile int state;
}
</code></pre></div><p>state:同步状态标识，当状态标识为0时，代表着当前没有线程占用锁资源；当状态标志=0，则代表已有线程占用了锁资源，如果状态标志大于0，则代表着占用锁资源的线程重入过多次，解锁时也需要同样的解锁多次。</p> <p>head为同步队列（CLH）的头部，但需要注意点head节点为空，不存储信息，而tail指向同步队列的尾部。AQS中同步队列（CLH）采用这种方式构建双向链表结构，方便队列 进行增删操作。</p> <p>Node节点：是对每个 等待获取锁的线程的封装体。其中包含了当前执行的线程及线程的状态，如是否阻塞、是否处于等待唤醒、是否中断等。每个Node都有一个前驱节点prev以及后继节点next,这样可以更方便持有锁的线程释放后能快速执行下一个正在等待的线程。</p> <p>Node节点的示意图：</p> <p><img src="D:%5CGitHub%5Cthink-studio%5Cback-end%5Cdocs.vuepress%5Cpublic%5Cassets%5Cimg%5Cthreads%5CAQS_Node.png" alt="AQS_Node"></p> <p>Node源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
    <span class="token comment">// 共享模式</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> <span class="token constant">SHARED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 独占模式</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> <span class="token constant">EXCLUSIVE</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 标识线程已处于结束状态</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span> <span class="token operator">=</span>  <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待被唤醒状态</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SIGNAL</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// Condition条件状态</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONDITION</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 在共享模式中使用表示获得的同步状态会被传播</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PROPAGATE</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待状态,存在CANCELLED、SIGNAL、CONDITION、PROPAGATE四种</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> waitStatus<span class="token punctuation">;</span>

    <span class="token comment">// 同步队列中前驱结点</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Node</span> prev<span class="token punctuation">;</span>

    <span class="token comment">// 同步队列中后继结点</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Node</span> next<span class="token punctuation">;</span>

    <span class="token comment">// 获取锁资源的线程</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>

    <span class="token comment">// 等待队列中的后继结点（与Condition有关，稍后会分析）</span>
    <span class="token class-name">Node</span> nextWaiter<span class="token punctuation">;</span>

    <span class="token comment">// 判断是否为共享模式</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nextWaiter <span class="token operator">==</span> <span class="token constant">SHARED</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取前驱结点</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> <span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NullPointerException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> p <span class="token operator">=</span> prev<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SHARED：共享模式，即允许多个线程同时对一个锁资源进行操作，例如：信号量Semaphore、读锁ReadLock等采用的就是基于AQS的共享模式实现的。</p> <p>EXCLUSIVE：独占模式，即同一时刻只运行一个线程对锁资源进行操作，如ReentrantLock等组件就是基于AQS的独占锁实现。</p> <p>全局变量waitStatus则代表着当前被封装成Node节点的线程的状态，分别是：</p> <p>​		0 ：初始值状态，代表着节点初始化</p> <p>​		CANCELLED:取消状态，waitstatus=1,在同步队列中等待的线程等待超时或被中断，需要从同步队列中取消该Node的节点，进入该状态后的节点代表着结束状态，当前节点不会再发生变化。</p> <p>​		SIGNAL:信号状态，waitStatus=-1,被标识为该状态的节点，当其前驱节点的线程释放了锁资源或被取消，将会通知该节点的线程执行。通俗的讲就是被标记为该状态的节点处于等于唤醒状态，只要前驱节点释放锁，就会通知标识为SIGNAL状态的后续节点的线程执行。</p> <p>​		CONDITION:条件状态，waitStatus=-2,与Condition相关，被表示为该状态的节点处于等待队列中，节点的线程等待在Condition条件，当其他线程调用了Condition的signal()方法后，CONDITION状态的节点将从等待队列转移到同步队列中，等待获取竞争锁资源。</p> <p>​		PROPAGATE:传播状态，waitStatus= -3,该状态与共享模式有关，在共享模式中，被标识为该状态的节点的线程处于可运行的状态。</p> <p>​</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/think-studio/back-end/edit/learn-warehouse/docs/back-end-basic/java线程/04-AbstractQueuedSynchronizer.md" target="_blank" rel="noopener noreferrer">欢迎来到思考学习仓库,一起沉淀知识</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/back-end/back-end-basic/java线程/03-ReentrantLock.html" class="prev">
        ReentrantLock
      </a></span> <span class="next"><a href="/back-end/back-end-basic/java线程/thread.html">
        thread
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/back-end/assets/js/app.e2101455.js" defer></script><script src="/back-end/assets/js/2.733019b2.js" defer></script><script src="/back-end/assets/js/15.25f2f025.js" defer></script>
  </body>
</html>
