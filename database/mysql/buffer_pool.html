<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>buffer_pool | 思考学习仓库</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="思考学习仓库沉淀">
    
    <link rel="preload" href="/back-end/assets/css/0.styles.e1ce56f9.css" as="style"><link rel="preload" href="/back-end/assets/js/app.02f0d5f1.js" as="script"><link rel="preload" href="/back-end/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/back-end/assets/js/61.8a64963b.js" as="script">
    <link rel="stylesheet" href="/back-end/assets/css/0.styles.e1ce56f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/back-end/" class="home-link router-link-active"><!----> <span class="site-name">思考学习仓库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/back-end/" class="nav-link">
  思考学习仓库
</a></div><div class="nav-item"><a href="/back-end/back-end-basic/" class="nav-link">
  java基础
</a></div><div class="nav-item"><a href="/back-end/middleware/" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/back-end/spring/" class="nav-link">
  Spring框架
</a></div><div class="nav-item"><a href="/back-end/microservices/" class="nav-link">
  微服务框架
</a></div><div class="nav-item"><a href="/back-end/database/" class="nav-link router-link-active">
  数据库篇章
</a></div> <a href="https://github.com/think-studio/back-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/back-end/" class="nav-link">
  思考学习仓库
</a></div><div class="nav-item"><a href="/back-end/back-end-basic/" class="nav-link">
  java基础
</a></div><div class="nav-item"><a href="/back-end/middleware/" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/back-end/spring/" class="nav-link">
  Spring框架
</a></div><div class="nav-item"><a href="/back-end/microservices/" class="nav-link">
  微服务框架
</a></div><div class="nav-item"><a href="/back-end/database/" class="nav-link router-link-active">
  数据库篇章
</a></div> <a href="https://github.com/think-studio/back-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>mysql</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back-end/database/mysql/mysql基础.html" class="sidebar-link">mysql基础</a></li><li><a href="/back-end/database/mysql/mysql锁.html" class="sidebar-link">mysql锁</a></li><li><a href="/back-end/database/mysql/msyql索引.html" class="sidebar-link">mysql索引</a></li><li><a href="/back-end/database/mysql/mvcc和read_view.html" class="sidebar-link">mvcc和read_view</a></li><li><a href="/back-end/database/mysql/buffer_pool.html" aria-current="page" class="active sidebar-link">buffer_pool</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back-end/database/mysql/buffer_pool.html#buffer-pool-lru-algorithm" class="sidebar-link">Buffer Pool LRU Algorithm</a></li><li class="sidebar-sub-header"><a href="/back-end/database/mysql/buffer_pool.html#buffer-pool-配置" class="sidebar-link">Buffer Pool 配置</a></li></ul></li><li><a href="/back-end/database/mysql/mysql三大日志.html" class="sidebar-link">mysql三大日志</a></li><li><a href="/back-end/database/mysql/mysql主从.html" class="sidebar-link">mysql主从</a></li><li><a href="/back-end/database/mysql/mysql执行一条sql过程.html" class="sidebar-link">mysql执行一条sql过程</a></li><li><a href="/back-end/database/oltp/oltp型数据库.html" class="sidebar-link">oltp型数据库</a></li><li><a href="/back-end/database/olap/olap分析型数据库.html" class="sidebar-link">olap分析型数据库</a></li><li><a href="/back-end/database/mpp/mpp型数据库.html" class="sidebar-link">mpp型数据库</a></li><li><a href="/back-end/database/mysql/InnoDB.html" class="sidebar-link">InnoDB</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="buffer-pool"><a href="#buffer-pool" class="header-anchor">#</a> buffer_pool</h1> <p>buffer pool是主内存中的一个区域,InnoDB 引擎会将访问过的表和索引数据缓存在这个区域中。buffer pool 允许经常使用的数据可以直接从内存中访问,这可以加快处理速度。对于 Dedicated servers （专用服务器）, 通常会将高达物理内存的80%分配给 buffer pool。</p> <p>为了高效率的大量读取操作,缓冲池被分成可容纳多个行的数据页。</p> <p>为了高效率的缓存管理,缓冲池被实现为一个链接列表的页面;很少使用的数据会通过变种的最近最少使用(LRU)算法从缓存中淘汰。
了解如何利用缓冲池来保持频繁访问的数据在内存中,是 MySQL 调优的一个重要方面。</p> <p>这是 BufferPool 在 InnoDB 中的位置
<img src="https://dev.mysql.com/doc/refman/8.0/en/images/innodb-architecture-8-0.png" alt=""></p> <h2 id="buffer-pool-lru-algorithm"><a href="#buffer-pool-lru-algorithm" class="header-anchor">#</a> Buffer Pool LRU Algorithm</h2> <p>buffer pool 是使用 LRU 算法变体管理一个链表。当需要为 buffer pool 添加新页面( page )时,最近最少使用的页面会被淘汰,新的页面会添加到链表的中间。这种中间插入策略把链表视为两个子链表:</p> <ul><li>在头部,包含新添加(&quot;年轻&quot;)但最近访问的页的 sublist （子列表）</li> <li>在尾部,包含较旧但访问较少的页面的子链表</li></ul> <h3 id="figure-15-2-buffer-pool-list"><a href="#figure-15-2-buffer-pool-list" class="header-anchor">#</a> Figure 15.2 Buffer Pool List</h3> <p><img src="https://dev.mysql.com/doc/refman/8.0/en/images/innodb-buffer-pool-list.png" alt=""></p> <p>该算法将频繁使用的页保存在 New Sublist （新子列表）中。Old Sublist （旧子列表） 包含使用频率较低的页面; 这些页可能会被<a href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_eviction" target="_blank" rel="noopener noreferrer">淘汰<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)。</p> <p>默认情况下，算法运行如下:</p> <ul><li>缓存池的 3/8 用于旧子列表。</li> <li>列表的 midpoint （中点）是新子列表的尾部与旧子列表的头部相接的边界。</li> <li>当 InnoDB 将页读入缓冲池时，它最初将其插入到中点(旧子列表的头部)，一个页可以被读取，因为它是用户发起的操作(如 SQL 查询)所必需的，或者是作为 InnoDB 自动执行的 <a href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_read_ahead" target="_blank" rel="noopener noreferrer">read-ahead<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（预读）操作的一部分。</li> <li>访问旧子列表中的一个页面会使这个页面&quot;变年轻&quot;,将它移动到新子列表的头部。如果这个页面是因为用户发起的操作需要而读取的,那么首次访问将立即发生,这个页面就会年轻化。 如果这个页面是由于预读操作读取的,那么首次访问可能不会立即发生,也可能在这个页面被淘汰之前都不会发生。</li> <li>当数据库运行的时候,未被访问的 buffer pool 中的页会随时间&quot;变老&quot;,通过移动到链表的尾部实现。页既在新子列表,也在旧子列表中&quot;变老&quot;,这取决于其他页面&quot;变得年轻&quot;。旧子列表中的页面还会随着新页面插入到中点位置而&quot;变老&quot;。最终,如果一个页面长时间未被使用,它最终会移动到旧子列表的末尾,并被淘汰。</li></ul> <p>查看 midpoint</p> <div class="language- extra-class"><pre class="language-text"><code>mysql&gt; show variables like 'innodb_old_blocks_pct';
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| innodb_old_blocks_pct | 37    |
+-----------------------+-------+
1 row in set (0.01 sec)
</code></pre></div><p>37: 末尾处的 37% 的位置，即末尾 3/8 的位置</p> <h3 id="局部性原理与预读机制"><a href="#局部性原理与预读机制" class="header-anchor">#</a> 局部性原理与预读机制</h3> <p>局部性原理</p> <ul><li>时间局部性：如果一个数据现在被访问了，在近期可能还会被多次访问。</li> <li>空间局部性：如果一个数据被访问了，那么存储在它附近的数据，很有可能立马被访问。</li></ul> <p>预读机制</p> <p>MySQL 为了提高性能，提供了预读机制。</p> <p>当你从磁盘上加载一个数据页的时候，他可能会连带着把这个数据页相邻的其他数据页，也加载到缓存里去。这个机制会带来这么一个问题：连带的数据页可能在后面的查询或者修改中，并不会用到，但是它们却在 lru 链表的头部。</p> <p><em>为什么要使用 LRU</em></p> <p>因为内存的大小是有限的，不可能无限的存放数据；</p> <p>当请求的数据不存在的时候，我们只能去硬盘拿，这样速度会变慢，所以我们要尽可能的避免这种情况的发生。当内存的数据满了的时候，把用户经常访问的数据留着，淘汰一些不经常被访问的数据，腾出位置存放新访问的数据，这样就能提高效率，所以这里选择 LRU （最近最少使用）来对不经常访问的数据进行淘汰。</p> <p><em>为什么MySQL 不使用传统的 LRU</em></p> <p>使用传统 LRU 的缺点：索引扫描/数据扫描/全表扫描，会使 buffer pool 中大量的页被刷新出去。然而被扫描到的数据页只是本次操作所需要的，并非热点数据。而真正的热点数据还是从磁盘读取，影响了 buffer pool 效率。</p> <p><img src="https://camo.githubusercontent.com/4e17ae3810ddcc6ccec7c6374702e8bdff4b24e1d6a86ecdbb73345d8e75a835/68747470733a2f2f63646e2e6e6c61726b2e636f6d2f79757175652f302f323032312f706e672f313436313639342f313633383435323838363632302d35323564636636362d366464652d343832322d616561332d3162396535653135346338362e706e6723636c69656e7449643d7532636564383133302d653939332d342663726f703d302663726f703d302663726f703d312663726f703d312666726f6d3d7061737465266865696768743d3638352669643d753565666336666463266d617267696e3d2535426f626a6563742532304f626a656374253544266e616d653d696d6167652e706e67266f726967696e4865696768743d31333730266f726967696e57696474683d31353830266f726967696e616c547970653d62696e61727926726174696f3d3126726f746174696f6e3d302673686f775469746c653d66616c73652673697a653d31303835373130267374617475733d646f6e65267374796c653d6e6f6e65267461736b49643d7566323264356366632d373631342d343166302d383261652d6333303837646339303662267469746c653d2677696474683d373930" alt=""></p> <p><em>为什么不把最新查到的数据放到首部?</em>
放在首部就和传统 LRU 一样了</p> <h2 id="buffer-pool-配置"><a href="#buffer-pool-配置" class="header-anchor">#</a> Buffer Pool 配置</h2> <p>待完成</p> <p>参考链接</p> <ul><li><a href="https://dev.mysql.com/blog-archive/mysql-8-0-new-lock-free-scalable-wal-design/" target="_blank" rel="noopener noreferrer">MySQL 8.0: New Lock free, scalable WAL design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/7007623642699792415" target="_blank" rel="noopener noreferrer">老面试官问我：LRU 和 Innodb Buffer Pool 有什么关系？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/think-studio/back-end/edit/learn-warehouse/docs/database/mysql/buffer_pool.md" target="_blank" rel="noopener noreferrer">欢迎来到思考学习仓库,一起沉淀知识</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/back-end/database/mysql/mvcc和read_view.html" class="prev">
        mvcc和read_view
      </a></span> <span class="next"><a href="/back-end/database/mysql/mysql三大日志.html">
        mysql三大日志
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/back-end/assets/js/app.02f0d5f1.js" defer></script><script src="/back-end/assets/js/2.733019b2.js" defer></script><script src="/back-end/assets/js/61.8a64963b.js" defer></script>
  </body>
</html>
